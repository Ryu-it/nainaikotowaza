<%= render "shared/flash_message" %>
<div class="min-h-screen bg-gradient-to-b from-slate-900 via-rose-950/70 to-slate-950 flex items-center justify-center px-4 py-12">
  <div class="w-full max-w-4xl">
    <div class="text-center text-white space-y-4 mb-20">
      <h1 class="text-4xl md:text-5xl font-bold">ふたりで生む、世界にひとつのことわざ</h1>
      <p class="text-base md:text-lg text-white/80">
        気になる相手を選んで、言葉を組み合わせてみましょう。
        会話を重ねるほど、物語が動き出します。
      </p>
    </div>
    <!-- メインカード -->
    <div class="bg-white/90 border border-white/30 rounded-3xl shadow-2xl px-8 py-16 backdrop-blur space-y-10"
         data-controller="radio-select">

      <!-- タイトル -->
      <div class="text-center space-y-4">
        <h2 class="text-3xl sm:text-4xl font-semibold text-slate-900">誰と一緒に作りますか？</h2>
        <p class="text-sm text-rose-300">(フォローしている人のみ)</p>
      </div>

      <div class="flex justify-center gap-3 mb-6 text-xs sm:text-sm">

  <%= link_to "過去に一緒に作った人を表示する",
              params[:past_collaborators].present? ? new_room_path : new_room_path(past_collaborators: true),
              class: "px-4 py-2 rounded-full border transition " \
                     "#{params[:past_collaborators].present? ? 'bg-slate-900 text-white border-slate-900' : 'bg-white/10 text-slate-900 border-white/50'}" %>
      </div>

      <!-- 検索フォーム -->
      <div class="w-full max-w-xl mx-auto">
        <%= search_form_for @q, url: new_room_path, method: :get do |f| %>
          <!-- form送信後past_collaborators　が消えるので パラメータを維持 -->
          <% if params[:past_collaborators].present? %>
            <%= hidden_field_tag :past_collaborators, params[:past_collaborators] %>
          <% end %>

          <div class="relative flex flex-col gap-4 sm:flex-row sm:items-center">
            <div class="relative flex-1">
              <i class="fa-solid fa-magnifying-glass absolute left-5 top-1/2 -translate-y-1/2 text-gray-400 text-lg"></i>
              <%= f.search_field :name_cont,
                    class: "w-full rounded-2xl border border-gray-200 bg-white px-12 py-3 text-lg text-gray-900 shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-rose-200",
                    placeholder: (params[:past_collaborators].present? ? "過去に一緒に作ったユーザーを絞り込む" : "ユーザーを探す") %>
            </div>
            <%= f.submit "検索",
                        class: "w-full sm:w-auto bg-blue-500 hover:bg-blue-400 text-white font-semibold rounded-2xl px-8 py-3 transition" %>
          </div>
        <% end %>
      </div>

      <%= form_with model: @room do |f| %>
        <!-- create 時にも past_collaborators を維持 -->
        <% if params[:past_collaborators].present? %>
          <%= hidden_field_tag :past_collaborators, params[:past_collaborators] %>
        <% end %>

        <div class="w-full max-w-2xl mx-auto space-y-4">
          <% @users.each do |user| %>
            <% next if user == current_user %> <!-- 自分は表示しない -->

            <div class="flex items-center justify-between rounded-2xl border border-rose-50 bg-gradient-to-br from-white via-rose-50/60 to-white px-5 py-4 shadow-sm hover:shadow-md transition cursor-pointer select-none"
                 data-action="click->radio-select#rowClick"
                 data-radio-select-name-value="<%= user.name %>">

              <!-- 左：ラジオ + 丸アイコン + 名前 -->
              <label class="flex items-center gap-4">
                <%= f.radio_button :user_id, user.id,
                      class: "w-4 h-4 text-rose-500 border-gray-300 focus:ring-rose-400",
                      data: { radio_select_target: "radio",
                              action: "change->radio-select#pick",
                              radio_select_name: user.name } %>
                <div class="flex flex-col">
                  <p class="text-base sm:text-lg font-medium text-slate-800"><%= user.name %></p>
                </div>
              </label>

              <!-- 右：フォローボタン（このクリックは選択に反応しない） -->
              <div data-radio-select-ignore>
                <%= render "shared/follow_button", user: user %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- 選択中ユーザー名とボタン -->
        <div class="text-center mt-24">
          <input id="selected_user_name"
                 type="text"
                 readonly
                 placeholder="ユーザーを選択してください"
                 data-radio-select-target="field"
                 class="w-72 border border-gray-200 rounded-2xl py-3 px-4 text-center text-gray-800 font-medium mb-6 focus:outline-none focus:ring-2 focus:ring-rose-200">
          <br>
          <%= f.submit "部屋を作る",
                data: { radio_select_ignore: true },
                class: "inline-flex justify-center bg-blue-500 hover:bg-blue-400 text-white font-medium py-3 px-10 rounded-2xl transition shadow" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
